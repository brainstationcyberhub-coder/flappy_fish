<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Fish Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Russo+One&family=Poppins:wght@300;400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        body {
            font-family: 'Orbitron', sans-serif;
            background: #000;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
            background: radial-gradient(ellipse at center, #000428 0%, #000722 50%, #000 100%);
            perspective: 1000px;
        }
        
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        
        #game-container {
            position: relative;
            width: 100%;
            max-width: 480px;
            height: 800px;
            overflow: hidden;
            border-radius: 25px;
            box-shadow: 
                0 0 60px rgba(0, 245, 212, 0.4),
                0 0 120px rgba(0, 187, 249, 0.2),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
            border: 4px solid;
            border-image: linear-gradient(45deg, #00f5d4, #00bbf9, #0066cc) 1;
            z-index: 1;
            transform-style: preserve-3d;
            animation: containerGlow 4s infinite alternate;
        }
        
        @keyframes containerGlow {
            0% { box-shadow: 0 0 40px rgba(0, 245, 212, 0.3), 0 0 80px rgba(0, 187, 249, 0.2); }
            100% { box-shadow: 0 0 80px rgba(0, 245, 212, 0.5), 0 0 120px rgba(0, 187, 249, 0.3); }
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            filter: contrast(1.1) saturate(1.2);
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        .corner-decoration {
            position: absolute;
            width: 100px;
            height: 100px;
            z-index: 2;
        }
        
        .corner-tl {
            top: -20px;
            left: -20px;
            transform: rotate(135deg);
        }
        
        .corner-tr {
            top: -20px;
            right: -20px;
            transform: rotate(45deg);
        }
        
        .corner-bl {
            bottom: -20px;
            left: -20px;
            transform: rotate(-135deg);
        }
        
        .corner-br {
            bottom: -20px;
            right: -20px;
            transform: rotate(-45deg);
        }
        
        .corner-line {
            position: absolute;
            background: linear-gradient(45deg, #00f5d4, #00bbf9);
        }
        
        .corner-line:nth-child(1) {
            width: 40px;
            height: 3px;
            top: 50%;
            left: 0;
        }
        
        .corner-line:nth-child(2) {
            width: 3px;
            height: 40px;
            top: 0;
            left: 50%;
        }
        
        #start-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at 50% 50%, rgba(0, 10, 30, 0.95) 0%, rgba(0, 20, 40, 0.9) 100%);
            color: white;
            z-index: 10;
            text-align: center;
            backdrop-filter: blur(5px);
            transform-style: preserve-3d;
        }
        
        #game-over-screen {
            display: none;
        }
        
        .screen-content {
            transform: translateZ(50px);
            position: relative;
            padding: 40px;
            background: rgba(0, 20, 40, 0.7);
            border-radius: 20px;
            border: 2px solid rgba(0, 245, 212, 0.3);
            box-shadow: 
                0 0 50px rgba(0, 245, 212, 0.2),
                inset 0 0 30px rgba(0, 245, 212, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .screen-content::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00f5d4, #00bbf9, #0066cc);
            border-radius: 22px;
            z-index: -1;
            animation: borderGlow 2s infinite linear;
        }
        
        @keyframes borderGlow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        .title-container {
            position: relative;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Russo One', sans-serif;
            background: linear-gradient(45deg, #00f5d4, #00bbf9, #0066cc);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: titleGlow 2s infinite alternate;
            position: relative;
            z-index: 1;
        }
        
        @keyframes titleGlow {
            0% { text-shadow: 0 0 10px #00f5d4, 0 0 20px #00bbf9, 0 0 30px #0066cc; }
            100% { text-shadow: 0 0 20px #00f5d4, 0 0 40px #00bbf9, 0 0 60px #0066cc; }
        }
        
        .title-shadow {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 0;
            font-size: 3.5rem;
            font-family: 'Russo One', sans-serif;
            color: transparent;
            -webkit-text-stroke: 2px rgba(0, 245, 212, 0.3);
            z-index: 0;
        }
        
        .score-display {
            font-size: 2rem;
            margin: 0.5rem 0;
            font-family: 'Orbitron', monospace;
            color: #fff;
            text-shadow: 0 0 10px #00bbf9;
            position: relative;
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(0, 245, 212, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .score-display::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00f5d4, #00bbf9, #0066cc);
            border-radius: 17px;
            z-index: -1;
            opacity: 0.5;
        }
        
        .button-container {
            position: relative;
            margin-top: 2rem;
            transform-style: preserve-3d;
            perspective: 500px;
        }
        
        button {
            position: relative;
            margin-top: 1.5rem;
            padding: 18px 45px;
            font-size: 1.4rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            background: linear-gradient(135deg, #00f5d4 0%, #00bbf9 50%, #0066cc 100%);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 
                0 10px 20px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(0, 245, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 2px;
            overflow: hidden;
            transform-style: preserve-3d;
            z-index: 1;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            border-radius: 50px;
            z-index: 2;
        }
        
        button::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #00f5d4, #00bbf9, #0066cc);
            border-radius: 52px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
            animation: buttonBorder 3s infinite linear;
        }
        
        @keyframes buttonBorder {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.4),
                0 0 50px rgba(0, 245, 212, 0.6);
        }
        
        button:hover::after {
            opacity: 1;
        }
        
        button:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(0, 245, 212, 0.4);
        }
        
        button span {
            position: relative;
            z-index: 3;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        #current-score {
            position: absolute;
            top: 40px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 2.8rem;
            font-family: 'Orbitron', monospace;
            color: #fff;
            z-index: 5;
            text-shadow: 
                0 0 10px #00f5d4,
                0 0 20px #00bbf9,
                0 0 30px #0066cc;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            pointer-events: none;
        }
        
        .score-flash {
            animation: scoreFlash 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes scoreFlash {
            0% { transform: scale(1) translateZ(0); }
            50% { transform: scale(1.3) translateZ(20px); color: #00f5d4; }
            100% { transform: scale(1) translateZ(0); }
        }
        
        .instructions {
            margin: 1rem 2rem;
            font-size: 1.1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Poppins', sans-serif;
            max-width: 80%;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            background: rgba(0, 20, 40, 0.5);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(0, 245, 212, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .fish-icon {
            width: 120px;
            height: 90px;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 0 20px #00f5d4);
            animation: float 3s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }
        
        .fish-icon::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(circle, rgba(0,245,212,0.2) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            animation: pulse 2s infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(0.8); }
            50% { opacity: 0.8; transform: scale(1); }
        }
        
        #sound-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 20, 40, 0.7);
            border: 2px solid rgba(0, 245, 212, 0.3);
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        #sound-toggle:hover {
            background: rgba(0, 245, 212, 0.2);
            border-color: #00f5d4;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 245, 212, 0.4);
        }
        
        #sound-toggle:active {
            transform: scale(0.95);
        }
        
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
        }
        
        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(0,245,212,0.8) 0%, transparent 70%);
            border-radius: 50%;
            animation: particleFloat 20s infinite linear;
        }
        
        @keyframes particleFloat {
            0% { transform: translateY(100vh) translateX(0) scale(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) translateX(100px) scale(1); opacity: 0; }
        }
        
        .controls-hint {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            animation: hintPulse 2s infinite;
            pointer-events: none;
        }
        
        @keyframes hintPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .game-over-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 6;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255,50,50,0.8) 0%, transparent 70%);
            border-radius: 50%;
            animation: explode 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        @media (max-width: 768px) {
            #game-container {
                max-width: 100%;
                height: 100vh;
                border-radius: 0;
                border: none;
                box-shadow: none;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .score-display {
                font-size: 1.6rem;
            }
            
            button {
                padding: 15px 35px;
                font-size: 1.2rem;
            }
            
            #current-score {
                font-size: 2.2rem;
                top: 60px;
            }
        }
        
        @media (max-height: 600px) {
            #game-container {
                height: 100vh;
                max-height: 600px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .fish-icon {
                width: 80px;
                height: 60px;
            }
            
            button {
                padding: 12px 25px;
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) and (orientation: portrait) {
            #game-container {
                transform: rotate(0deg);
            }
            
            .instructions {
                font-size: 0.9rem;
                padding: 15px;
            }
            
            .controls-hint {
                font-size: 0.8rem;
                bottom: 20px;
            }
        }
        
        @media (max-height: 400px) and (orientation: landscape) {
            #game-container {
                max-width: 90vw;
                height: 90vh;
            }
            
            .screen-content {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .score-display {
                font-size: 1.4rem;
                padding: 10px 20px;
            }
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid transparent;
            border-top: 4px solid #00f5d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(0, 245, 212, 0.5);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .achievement-badge {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #00f5d4, #00bbf9);
            color: #000;
            padding: 15px 30px;
            border-radius: 25px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            pointer-events: none;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .achievement-badge.show {
            transform: translate(-50%, -50%) scale(1);
        }
    </style>
</head>
<body>
    <div class="starfield" id="starfield"></div>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loader"></div>
    </div>
    
    <div id="game-container">
        <div class="corner-decoration corner-tl">
            <div class="corner-line"></div>
            <div class="corner-line"></div>
        </div>
        <div class="corner-decoration corner-tr">
            <div class="corner-line"></div>
            <div class="corner-line"></div>
        </div>
        <div class="corner-decoration corner-bl">
            <div class="corner-line"></div>
            <div class="corner-line"></div>
        </div>
        <div class="corner-decoration corner-br">
            <div class="corner-line"></div>
            <div class="corner-line"></div>
        </div>
        
        <div class="particles" id="particles"></div>
        
        <div id="ui-overlay">
            <button id="sound-toggle">ðŸ”Š</button>
            <div id="current-score">0</div>
            <div class="controls-hint" id="controls-hint">TAP / CLICK / SPACE TO SWIM</div>
        </div>
        
        <canvas id="game-canvas"></canvas>
        
        <div id="start-screen">
            <div class="screen-content">
                <div class="title-container">
                    <h1>Flappy Fish Pro</h1>
                    <div class="title-shadow">Flappy Fish Pro</div>
                </div>
                
                <svg class="fish-icon" viewBox="0 0 120 90">
                    <path d="M90,45 Q105,30 90,15 L60,45 L30,15 Q15,30 30,45 L60,75 Z" fill="#00f5d4"/>
                    <circle cx="80" cy="40" r="5" fill="black"/>
                    <path d="M70,45 Q75,50 80,45" stroke="black" stroke-width="3" fill="none"/>
                    <path d="M85,42 Q87,44 90,42" stroke="#00bbf9" stroke-width="2" fill="none"/>
                </svg>
                
                <p class="instructions">Navigate through coral reefs, avoid predators, and collect points in this deep sea adventure!</p>
                
                <div class="score-display" id="best-score-display">BEST: 0</div>
                
                <div class="button-container">
                    <button id="start-button">
                        <span>START ADVENTURE</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="game-over-screen">
            <div class="screen-content">
                <div class="title-container">
                    <h1>GAME OVER</h1>
                    <div class="title-shadow">GAME OVER</div>
                </div>
                
                <div class="score-display" id="final-score">SCORE: 0</div>
                <div class="score-display" id="best-score">BEST: 0</div>
                
                <div class="button-container">
                    <button id="restart-button">
                        <span>TRY AGAIN</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="game-over-animation" id="game-over-animation"></div>
    </div>
    
    <div class="achievement-badge" id="achievement-badge"></div>

    <audio id="bg-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-deep-sea-ambience-1173.mp3" type="audio/mpeg">
    </audio>
    <audio id="jump-sound">
        <source src="https://tcsdemonic.vercel.app/jump.mp3" type="audio/mpeg">
    </audio>
    <audio id="score-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameover-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sad-game-over-trombone-471.mp3" type="audio/mpeg">
    </audio>
    <audio id="achievement-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const currentScore = document.getElementById('current-score');
        const finalScore = document.getElementById('final-score');
        const bestScore = document.getElementById('best-score');
        const bestScoreDisplay = document.getElementById('best-score-display');
        const soundToggle = document.getElementById('sound-toggle');
        const loadingOverlay = document.getElementById('loading-overlay');
        const controlsHint = document.getElementById('controls-hint');
        const gameOverAnimation = document.getElementById('game-over-animation');
        const achievementBadge = document.getElementById('achievement-badge');
        const particlesContainer = document.getElementById('particles');
        const starfield = document.getElementById('starfield');
        
        const bgMusic = document.getElementById('bg-music');
        const jumpSound = document.getElementById('jump-sound');
        const scoreSound = document.getElementById('score-sound');
        const gameoverSound = document.getElementById('gameover-sound');
        const achievementSound = document.getElementById('achievement-sound');
        
        let soundEnabled = true;
        
        // Game state
        let gameRunning = false;
        let score = 0;
        let highScore = localStorage.getItem('flappyFishHighScore') || 0;
        let animationFrameId;
        let lastTime = 0;
        let achievementShown = false;
        
        // Fish properties
        const fish = {
            x: 100,
            y: 0,
            width: 40,
            height: 30,
            velocity: 0,
            gravity: 0.4,
            jumpForce: -9,
            rotation: 0,
            color: '#00f5d4',
            outline: '#00bbf9',
            trail: []
        };
        
        // Game elements
        let background = {
            x: 0,
            speed: 0.5
        };
        
        let corals = [];
        const coralWidth = 70;
        const gapHeight = 200;
        let coralSpeed = 2.5;
        let coralFrequency = 2000;
        let lastCoralTime = 0;
        
        // Bubbles
        let bubbles = [];
        
        // Background fish (sharks & whales)
        let backgroundFish = [];
        
        // Coral at the bottom (death obstacle)
        let bottomCoral = {
            x: 0,
            width: canvas.width,
            height: 30,
            spikes: []
        };
        
        // Initialize the game
        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Set initial fish position
            fish.y = canvas.height / 2;
            
            // Initialize bottom coral
            initBottomCoral();
            
            // Set up event listeners
            setupEventListeners();
            
            // Try to play background music
            bgMusic.volume = 0.3;
            
            // Show high score
            highScore = localStorage.getItem('flappyFishHighScore') || 0;
            bestScoreDisplay.textContent = `BEST: ${highScore}`;
            
            // Hide loading screen and show game
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    createStarfield();
                    createParticles();
                    draw();
                }, 500);
            }, 1000);
        }
        
        // Initialize bottom coral spikes
        function initBottomCoral() {
            bottomCoral.spikes = [];
            bottomCoral.width = canvas.width;
            for (let x = 0; x < canvas.width; x += 30) {
                bottomCoral.spikes.push({
                    x: x,
                    height: Math.random() * 15 + 10
                });
            }
        }
        
        // Create starfield background
        function createStarfield() {
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                star.style.opacity = Math.random() * 0.5 + 0.3;
                starfield.appendChild(star);
            }
        }
        
        // Create particles
        function createParticles() {
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 20 + 10;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 20}s`;
                particlesContainer.appendChild(particle);
            }
        }
        
        // Set canvas size
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            initBottomCoral(); // Reinitialize bottom coral on resize
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Game controls
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', startGame);
            
            // Sound toggle
            soundToggle.addEventListener('click', toggleSound);
            
            // Input handlers
            function handleInput() {
                if (gameRunning) {
                    fish.velocity = fish.jumpForce;
                    createBubbles();
                    if (soundEnabled) jumpSound.currentTime = 0;
                    if (soundEnabled) jumpSound.play().catch(e => console.log("Audio play error:", e));
                    
                    controlsHint.style.opacity = '0';
                }
            }
            
            canvas.addEventListener('click', handleInput);
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                handleInput();
            });
            
            document.addEventListener('keydown', function(e) {
                if ((e.code === 'Space' || e.key === 'ArrowUp') && gameRunning) {
                    handleInput();
                }
            });
        }
        
        // Toggle sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            soundToggle.textContent = soundEnabled ? "ðŸ”Š" : "ðŸ”‡";
            
            if (soundEnabled) {
                bgMusic.play().catch(e => console.log("Audio play error:", e));
            } else {
                bgMusic.pause();
            }
        }
        
        // Start game
        function startGame() {
            // Reset game state
            gameRunning = true;
            score = 0;
            currentScore.textContent = '0';
            fish.y = canvas.height / 2;
            fish.velocity = 0;
            fish.rotation = 0;
            corals = [];
            bubbles = [];
            backgroundFish = [];
            coralSpeed = 2.5;
            coralFrequency = 2000;
            achievementShown = false;
            
            // Start background music
            if (soundEnabled) {
                bgMusic.currentTime = 0;
                bgMusic.play().catch(e => console.log("Audio play error:", e));
            }
            
            // Hide screens
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            controlsHint.style.opacity = '1';
            gameOverAnimation.style.opacity = '0';
            gameOverAnimation.innerHTML = '';
            
            // Start game loop
            lastTime = performance.now();
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            gameLoop(lastTime);
        }
        
        // Game over
        function endGame() {
            gameRunning = false;
            cancelAnimationFrame(animationFrameId);
            
            // Play game over sound
            if (soundEnabled) {
                gameoverSound.currentTime = 0;
                gameoverSound.play().catch(e => console.log("Audio play error:", e));
            }
            
            createExplosion(fish.x + fish.width/2, fish.y + fish.height/2);
            
            // Update high score
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('flappyFishHighScore', highScore);
                
                if (!achievementShown) {
                    showAchievement("NEW RECORD!");
                    achievementShown = true;
                }
            }
            
            // Show game over screen
            finalScore.textContent = `SCORE: ${score}`;
            bestScore.textContent = `BEST: ${highScore}`;
            bestScoreDisplay.textContent = `BEST: ${highScore}`;
            
            setTimeout(() => {
                gameOverScreen.style.display = 'flex';
            }, 1000);
        }
        
        // Create explosion animation
        function createExplosion(x, y) {
            gameOverAnimation.style.opacity = '1';
            for (let i = 0; i < 8; i++) {
                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.left = `${x + Math.random() * 40 - 20}px`;
                explosion.style.top = `${y + Math.random() * 40 - 20}px`;
                explosion.style.animationDelay = `${Math.random() * 0.2}s`;
                explosion.style.background = `radial-gradient(circle, hsla(${Math.random() * 60 + 350}, 100%, 60%, 0.8) 0%, transparent 70%)`;
                gameOverAnimation.appendChild(explosion);
            }
        }
        
        // Show achievement badge
        function showAchievement(text) {
            achievementBadge.textContent = text;
            achievementBadge.classList.add('show');
            
            if (soundEnabled) {
                achievementSound.currentTime = 0;
                achievementSound.play().catch(e => console.log("Audio play error:", e));
            }
            
            setTimeout(() => {
                achievementBadge.classList.remove('show');
            }, 3000);
        }
        
        // Create coral obstacles
        function createCoral() {
            const gapPosition = Math.random() * (canvas.height - gapHeight - 150) + 75;
            
            corals.push({
                x: canvas.width,
                topHeight: gapPosition,
                bottomY: gapPosition + gapHeight,
                passed: false,
                color: `hsl(${Math.random() * 60 + 100}, 70%, 40%)`,
                details: []
            });
            
            // Add coral details
            const coral = corals[corals.length - 1];
            for (let y = 10; y < coral.topHeight; y += 20) {
                coral.details.push({
                    type: Math.random() > 0.3 ? 'circle' : 'spike',
                    x: coral.x + coralWidth/2 + Math.sin(y * 0.2) * 15,
                    y: y,
                    size: Math.random() * 8 + 5,
                    offset: Math.random() * Math.PI * 2
                });
            }
            
            for (let y = coral.bottomY + 10; y < canvas.height; y += 20) {
                coral.details.push({
                    type: Math.random() > 0.3 ? 'circle' : 'spike',
                    x: coral.x + coralWidth/2 + Math.sin(y * 0.2) * 15,
                    y: y,
                    size: Math.random() * 8 + 5,
                    offset: Math.random() * Math.PI * 2
                });
            }
        }
        
        // Create bubbles
        function createBubbles() {
            for (let i = 0; i < 5; i++) {
                bubbles.push({
                    x: fish.x + fish.width/2,
                    y: fish.y + fish.height/2,
                    size: Math.random() * 8 + 4,
                    speed: Math.random() * 2 + 1,
                    opacity: Math.random() * 0.5 + 0.3,
                    offset: Math.random() * Math.PI * 2
                });
            }
        }
        
        // Create background fish (sharks & whales)
        function createBackgroundFish() {
            if (Math.random() < 0.01 && backgroundFish.length < 3) {
                const type = Math.random() < 0.7 ? 'shark' : 'whale';
                backgroundFish.push({
                    x: canvas.width,
                    y: Math.random() * (canvas.height - 100) + 50,
                    width: type === 'shark' ? 80 : 120,
                    height: type === 'shark' ? 40 : 60,
                    speed: Math.random() * 1 + 1,
                    type: type,
                    bubbles: []
                });
            }
        }
        
        // Update game state
        function update(deltaTime) {
            // Update fish
            fish.velocity += fish.gravity;
            fish.y += fish.velocity;
            
            // Add to fish trail
            fish.trail.push({ x: fish.x + fish.width/2, y: fish.y + fish.height/2 });
            if (fish.trail.length > 10) {
                fish.trail.shift();
            }
            
            // Rotate fish based on velocity
            fish.rotation = Math.max(-30, Math.min(30, fish.velocity * 5));
            
            // Check boundaries
            if (fish.y < 0) {
                fish.y = 0;
                fish.velocity = 0;
            }
            
            // Check collision with bottom coral
            if (fish.y + fish.height > canvas.height - bottomCoral.height) {
                // Check if hit a spike
                for (const spike of bottomCoral.spikes) {
                    if (
                        fish.x + fish.width > spike.x &&
                        fish.x < spike.x + 30 &&
                        fish.y + fish.height > canvas.height - spike.height
                    ) {
                        endGame();
                        return;
                    }
                }
                fish.y = canvas.height - bottomCoral.height - fish.height;
                fish.velocity = 0;
            }
            
            // Update background
            background.x = (background.x - background.speed) % canvas.width;
            
            // Create new coral
            if (performance.now() - lastCoralTime > coralFrequency) {
                createCoral();
                lastCoralTime = performance.now();
                
                // Increase difficulty
                if (score > 0 && score % 10 === 0) {
                    coralSpeed += 0.1;
                    coralFrequency = Math.max(1500, coralFrequency - 50);
                }
            }
            
            // Update corals
            for (let i = corals.length - 1; i >= 0; i--) {
                corals[i].x -= coralSpeed;
                
                // Update coral details positions
                for (let detail of corals[i].details) {
                    detail.x -= coralSpeed;
                }
                
                // Check collision
                if (
                    fish.x + fish.width > corals[i].x &&
                    fish.x < corals[i].x + coralWidth &&
                    (fish.y < corals[i].topHeight || fish.y + fish.height > corals[i].bottomY)
                ) {
                    endGame();
                    return;
                }
                
                // Check if passed
                if (!corals[i].passed && fish.x > corals[i].x + coralWidth) {
                    corals[i].passed = true;
                    score++;
                    currentScore.textContent = score;
                    
                    // Play score sound
                    if (soundEnabled) {
                        scoreSound.currentTime = 0;
                        scoreSound.play().catch(e => console.log("Audio play error:", e));
                    }
                    
                    // Score animation
                    currentScore.classList.add('score-flash');
                    setTimeout(() => {
                        currentScore.classList.remove('score-flash');
                    }, 500);
                    
                    // Show achievements
                    if (score === 10 || score === 25 || score === 50) {
                        showAchievement(`${score} POINTS!`);
                    }
                }
                
                // Remove off-screen corals
                if (corals[i].x + coralWidth < 0) {
                    corals.splice(i, 1);
                }
            }
            
            // Update bubbles
            for (let i = bubbles.length - 1; i >= 0; i--) {
                bubbles[i].y -= bubbles[i].speed;
                bubbles[i].x += Math.sin(performance.now() * 0.001 + bubbles[i].offset) * 0.5;
                
                if (bubbles[i].y < -10) {
                    bubbles.splice(i, 1);
                }
            }
            
            // Update background fish
            createBackgroundFish();
            for (let i = backgroundFish.length - 1; i >= 0; i--) {
                backgroundFish[i].x -= backgroundFish[i].speed;
                
                // Add bubbles to background fish
                if (Math.random() < 0.05 && backgroundFish[i].bubbles.length < 5) {
                    backgroundFish[i].bubbles.push({
                        x: backgroundFish[i].x,
                        y: backgroundFish[i].y + backgroundFish[i].height/2,
                        size: Math.random() * 5 + 3,
                        speed: Math.random() * 1.5 + 0.5,
                        opacity: Math.random() * 0.4 + 0.3
                    });
                }
                
                // Update fish bubbles
                for (let j = backgroundFish[i].bubbles.length - 1; j >= 0; j--) {
                    backgroundFish[i].bubbles[j].y -= backgroundFish[i].bubbles[j].speed;
                    if (backgroundFish[i].bubbles[j].y < -10) {
                        backgroundFish[i].bubbles.splice(j, 1);
                    }
                }
                
                // Remove off-screen fish
                if (backgroundFish[i].x + backgroundFish[i].width < 0) {
                    backgroundFish.splice(i, 1);
                }
            }
        }
        
        // Draw game elements
        function draw() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw water background with depth effect
            const waterGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            waterGradient.addColorStop(0, '#000428');
            waterGradient.addColorStop(0.5, '#004e92');
            waterGradient.addColorStop(1, '#0061a8');
            ctx.fillStyle = waterGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw light rays effect
            ctx.save();
            ctx.globalAlpha = 0.1;
            for (let i = 0; i < 3; i++) {
                const x = (background.x * 0.5 + i * canvas.width / 3) % canvas.width;
                const gradient = ctx.createLinearGradient(x, 0, x + 50, 0);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
                gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.2)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            ctx.restore();
            
            // Draw sandy bottom with depth effect
            const sandGradient = ctx.createLinearGradient(0, canvas.height - bottomCoral.height, 0, canvas.height);
            sandGradient.addColorStop(0, '#e6c88c');
            sandGradient.addColorStop(1, '#d2b48c');
            ctx.fillStyle = sandGradient;
            ctx.fillRect(0, canvas.height - bottomCoral.height, canvas.width, bottomCoral.height);
            
            // Draw coral spikes at bottom with shadow
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 5;
            ctx.shadowOffsetY = 2;
            ctx.fillStyle = '#CD5C5C';
            for (const spike of bottomCoral.spikes) {
                ctx.beginPath();
                ctx.moveTo(spike.x, canvas.height - bottomCoral.height);
                ctx.lineTo(spike.x + 15, canvas.height - bottomCoral.height - spike.height);
                ctx.lineTo(spike.x + 30, canvas.height - bottomCoral.height);
                ctx.closePath();
                ctx.fill();
            }
            ctx.restore();
            
            // Draw background waves with glow
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.shadowColor = 'rgba(255, 255, 255, 0.5)';
            ctx.shadowBlur = 10;
            for (let i = 0; i < 5; i++) {
                const y = canvas.height - bottomCoral.height - i * 40;
                ctx.beginPath();
                ctx.moveTo(0, y);
                for (let x = 0; x < canvas.width; x += 20) {
                    ctx.lineTo(x, y + Math.sin(x * 0.05 + background.x * 0.1 + i) * 5);
                }
                ctx.stroke();
            }
            ctx.restore();
            
            // Draw fish trail
            if (fish.trail.length > 1) {
                ctx.save();
                ctx.globalCompositeOperation = 'lighter';
                for (let i = 0; i < fish.trail.length - 1; i++) {
                    const alpha = i / fish.trail.length;
                    ctx.strokeStyle = `rgba(0, 245, 212, ${alpha * 0.5})`;
                    ctx.lineWidth = 3 * alpha;
                    ctx.beginPath();
                    ctx.moveTo(fish.trail[i].x, fish.trail[i].y);
                    ctx.lineTo(fish.trail[i+1].x, fish.trail[i+1].y);
                    ctx.stroke();
                }
                ctx.restore();
            }
            
            // Draw background fish (sharks & whales)
            for (const fishObj of backgroundFish) {
                ctx.save();
                ctx.translate(fishObj.x + fishObj.width/2, fishObj.y + fishObj.height/2);
                
                if (fishObj.type === 'shark') {
                    // Draw shark with gradient
                    const sharkGradient = ctx.createLinearGradient(-fishObj.width/2, 0, fishObj.width/2, 0);
                    sharkGradient.addColorStop(0, '#5a5a5a');
                    sharkGradient.addColorStop(1, '#3a3a3a');
                    ctx.fillStyle = sharkGradient;
                    
                    // Shark body
                    ctx.beginPath();
                    ctx.ellipse(0, 0, fishObj.width/2, fishObj.height/2, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Shark tail
                    ctx.beginPath();
                    ctx.moveTo(-fishObj.width/2, 0);
                    ctx.lineTo(-fishObj.width/2 - 20, -fishObj.height/2);
                    ctx.lineTo(-fishObj.width/2 - 20, fishObj.height/2);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Shark fin with highlight
                    const finGradient = ctx.createLinearGradient(0, -fishObj.height/2, 20, -fishObj.height/2);
                    finGradient.addColorStop(0, '#7a7a7a');
                    finGradient.addColorStop(1, '#4a4a4a');
                    ctx.fillStyle = finGradient;
                    ctx.beginPath();
                    ctx.moveTo(0, -fishObj.height/2);
                    ctx.lineTo(10, -fishObj.height/2 - 15);
                    ctx.lineTo(20, -fishObj.height/2);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Shark eye with reflection
                    ctx.fillStyle = 'black';
                    ctx.beginPath();
                    ctx.arc(fishObj.width/2 - 15, -fishObj.height/4, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(fishObj.width/2 - 14, -fishObj.height/4 - 1, 1, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // Draw whale with gradient
                    const whaleGradient = ctx.createLinearGradient(-fishObj.width/2, 0, fishObj.width/2, 0);
                    whaleGradient.addColorStop(0, '#5a8ab8');
                    whaleGradient.addColorStop(1, '#3a6a98');
                    ctx.fillStyle = whaleGradient;
                    
                    // Whale body
                    ctx.beginPath();
                    ctx.ellipse(0, 0, fishObj.width/2, fishObj.height/2, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Whale tail
                    ctx.beginPath();
                    ctx.moveTo(-fishObj.width/2, 0);
                    ctx.lineTo(-fishObj.width/2 - 30, -fishObj.height/2);
                    ctx.lineTo(-fishObj.width/2 - 30, fishObj.height/2);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Whale eye with reflection
                    ctx.fillStyle = 'black';
                    ctx.beginPath();
                    ctx.arc(fishObj.width/2 - 20, -fishObj.height/4, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(fishObj.width/2 - 19, -fishObj.height/4 - 1, 1, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Draw fish bubbles
                for (const bubble of fishObj.bubbles) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${bubble.opacity})`;
                    ctx.beginPath();
                    ctx.arc(bubble.x - fishObj.x - fishObj.width/2, bubble.y - fishObj.y - fishObj.height/2, bubble.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Bubble highlight
                    ctx.fillStyle = `rgba(255, 255, 255, ${bubble.opacity + 0.2})`;
                    ctx.beginPath();
                    ctx.arc(
                        bubble.x - fishObj.x - fishObj.width/2 - bubble.size/3, 
                        bubble.y - fishObj.y - fishObj.height/2 - bubble.size/3, 
                        bubble.size/3, 
                        0, 
                        Math.PI * 2
                    );
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            // Draw corals with 3D effect
            for (const coral of corals) {
                // Top coral with gradient
                const topGradient = ctx.createLinearGradient(coral.x, 0, coral.x + coralWidth, 0);
                topGradient.addColorStop(0, coral.color);
                topGradient.addColorStop(1, shadeColor(coral.color, -20));
                ctx.fillStyle = topGradient;
                ctx.fillRect(coral.x, 0, coralWidth, coral.topHeight);
                
                // Bottom coral with gradient
                const bottomGradient = ctx.createLinearGradient(coral.x, coral.bottomY, coral.x + coralWidth, coral.bottomY);
                bottomGradient.addColorStop(0, coral.color);
                bottomGradient.addColorStop(1, shadeColor(coral.color, -20));
                ctx.fillStyle = bottomGradient;
                ctx.fillRect(coral.x, coral.bottomY, coralWidth, canvas.height - coral.bottomY);
                
                // Coral details with animation
                ctx.save();
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 5;
                ctx.shadowOffsetY = 2;
                
                for (const detail of coral.details) {
                    if (detail.type === 'circle') {
                        ctx.fillStyle = shadeColor(coral.color, 20);
                        ctx.beginPath();
                        ctx.arc(
                            detail.x, 
                            detail.y, 
                            detail.size * (0.8 + Math.sin(performance.now() * 0.001 + detail.offset) * 0.2), 
                            0, 
                            Math.PI * 2
                        );
                        ctx.fill();
                    } else {
                        ctx.fillStyle = shadeColor(coral.color, -10);
                        ctx.beginPath();
                        ctx.moveTo(detail.x, detail.y);
                        ctx.lineTo(
                            detail.x + detail.size * Math.cos(performance.now() * 0.001 + detail.offset), 
                            detail.y - detail.size * 1.5
                        );
                        ctx.lineTo(
                            detail.x + detail.size * Math.cos(performance.now() * 0.002 + detail.offset), 
                            detail.y
                        );
                        ctx.closePath();
                        ctx.fill();
                    }
                }
                ctx.restore();
            }
            
            // Draw bubbles with animation
            for (const bubble of bubbles) {
                ctx.fillStyle = `rgba(255, 255, 255, ${bubble.opacity})`;
                ctx.beginPath();
                ctx.arc(
                    bubble.x, 
                    bubble.y, 
                    bubble.size * (1 + Math.sin(performance.now() * 0.003 + bubble.offset) * 0.1), 
                    0, 
                    Math.PI * 2
                );
                ctx.fill();
                
                // Bubble highlight
                ctx.fillStyle = `rgba(255, 255, 255, ${bubble.opacity + 0.2})`;
                ctx.beginPath();
                ctx.arc(
                    bubble.x - bubble.size/3, 
                    bubble.y - bubble.size/3, 
                    bubble.size/3, 
                    0, 
                    Math.PI * 2
                );
                ctx.fill();
            }
            
            // Draw fish with advanced effects
            ctx.save();
            ctx.translate(fish.x + fish.width/2, fish.y + fish.height/2);
            ctx.rotate(fish.rotation * Math.PI / 180);
            
            // Fish body with gradient
            const fishGradient = ctx.createLinearGradient(-fish.width/2, 0, fish.width/2, 0);
            fishGradient.addColorStop(0, shadeColor(fish.color, -20));
            fishGradient.addColorStop(1, fish.color);
            ctx.fillStyle = fishGradient;
            
            // Fish body with shadow
            ctx.shadowColor = 'rgba(0, 187, 249, 0.5)';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.ellipse(0, 0, fish.width/2, fish.height/2, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Fish outline with glow
            ctx.strokeStyle = fish.outline;
            ctx.lineWidth = 2;
            ctx.shadowColor = fish.outline;
            ctx.shadowBlur = 5;
            ctx.stroke();
            
            // Fish tail with gradient
            const tailGradient = ctx.createLinearGradient(-fish.width/2, 0, -fish.width/2 - 15, 0);
            tailGradient.addColorStop(0, fish.color);
            tailGradient.addColorStop(1, shadeColor(fish.color, -30));
            ctx.fillStyle = tailGradient;
            
            ctx.beginPath();
            ctx.moveTo(-fish.width/2, 0);
            ctx.lineTo(-fish.width/2 - 15, -fish.height/2);
            ctx.lineTo(-fish.width/2 - 15, fish.height/2);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Fish eye with reflection
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(fish.width/2 - 10, -fish.height/3, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(fish.width/2 - 9, -fish.height/3 - 1, 1, 0, Math.PI * 2);
            ctx.fill();
            
            // Fish mouth (changes with velocity)
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            if (fish.velocity < 0) {
                // Smile when jumping
                ctx.arc(fish.width/2 - 5, 0, 5, 0, Math.PI);
            } else {
                // Frown when falling
                ctx.arc(fish.width/2 - 5, 5, 5, Math.PI, 2 * Math.PI);
            }
            ctx.stroke();
            
            ctx.restore();
        }
        
        // Helper function to shade colors
        function shadeColor(color, percent) {
            let R = parseInt(color.substring(1,3), 16);
            let G = parseInt(color.substring(3,5), 16);
            let B = parseInt(color.substring(5,7), 16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R<255)?R:255;  
            G = (G<255)?G:255;  
            B = (B<255)?B:255;  

            R = Math.round(R);
            G = Math.round(G);
            B = Math.round(B);

            const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
            const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
            const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

            return "#"+RR+GG+BB;
        }
        
        // Main game loop
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            if (gameRunning) {
                update(deltaTime);
                draw();
                animationFrameId = requestAnimationFrame(gameLoop);
            }
        }
        
        // Initialize the game when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
